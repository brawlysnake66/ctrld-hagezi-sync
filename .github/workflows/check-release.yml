name: Check for new release

on:
  schedule:
    - cron: "0 */2 * * *" # Every 2 hours
  workflow_dispatch:

permissions:
  actions: write

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get latest release tag
        id: release
        run: |
          TAG=$(curl -s https://api.github.com/repos/hagezi/dns-blocklists/releases/latest | jq -r .tag_name)
          if [ -z "$TAG" ] || [ "$TAG" = "null" ]; then
            echo "Failed to fetch release tag"
            exit 1
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Restore cached release tag
        id: tag-cache
        uses: actions/cache@v4
        with:
          path: .last-release-tag
          key: hagezi-release-${{ steps.release.outputs.tag }}

      - name: Compute files hash
        id: files
        if: steps.tag-cache.outputs.cache-hit != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COMBINED=""
          while IFS= read -r line; do
            [[ -z "$line" || "$line" == \#* ]] && continue
            API_URL=$(echo "$line" | sed 's|https://raw.githubusercontent.com/\([^/]*\)/\([^/]*\)/[^/]*/\(.*\)|https://api.github.com/repos/\1/\2/contents/\3|')
            SHA=$(curl -s -H "Authorization: Bearer $GH_TOKEN" "$API_URL" | jq -r '.sha // empty')
            if [ -n "$SHA" ]; then
              COMBINED="${COMBINED}${SHA}"
            else
              echo "Warning: could not fetch SHA for: $line"
            fi
          done < lists.txt
          HASH=$(echo -n "$COMBINED" | sha256sum | cut -d' ' -f1)
          echo "hash=$HASH" >> "$GITHUB_OUTPUT"
          echo "Files hash: $HASH"

      - name: Restore cached files hash
        id: files-cache
        if: steps.tag-cache.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: .last-files-hash
          key: hagezi-files-${{ steps.files.outputs.hash }}

      - name: Save state
        if: steps.tag-cache.outputs.cache-hit != 'true'
        run: |
          echo "${{ steps.release.outputs.tag }}" > .last-release-tag
          echo "${{ steps.files.outputs.hash }}" > .last-files-hash

      - name: Trigger sync workflow
        if: steps.tag-cache.outputs.cache-hit != 'true' && steps.files-cache.outputs.cache-hit != 'true'
        run: |
          echo "New release ${{ steps.release.outputs.tag }} with changed files detected, triggering sync"
          gh workflow run sync.yml
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
